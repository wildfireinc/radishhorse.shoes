<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>radishhorse.shoes - Room</title>
    <link rel="stylesheet" href="/styles.css">
    <script>
        // Default backend (will be updated from API config)
        window.BACKEND_URL = 'https://api.radishhorse.shoes';
        window.API_BASE = 'https://api.radishhorse.shoes';
        window.SOCKET_URL = 'https://api.radishhorse.shoes';
        
        // Fetch backend configuration
        (async function() {
            try {
                const response = await fetch('https://api.radishhorse.shoes/api/config');
                if (response.ok) {
                    const config = await response.json();
                    if (config.apiUrl) window.API_BASE = config.apiUrl;
                    if (config.socketUrl) window.SOCKET_URL = config.socketUrl;
                    if (config.backendUrl) window.BACKEND_URL = config.backendUrl;
                    console.log('Backend config loaded:', config);
                }
            } catch (err) {
                console.warn('Failed to load backend config, using defaults:', err);
            }
        })();
    </script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container room-container">
        <div class="logo-container">
            <h1 class="neon-logo small">radishhorse.shoes</h1>
        </div>

        <div class="video-grid" id="videoGrid">
            <!-- Remote videos will be added here dynamically when peers connect -->
        </div>

        <div class="room-info">
            <div class="room-url">
                <span>room:</span>
                <input type="text" id="roomUrl" readonly class="neon-input">
                <button id="copyBtn" class="neon-button small">copy</button>
            </div>
        </div>

        <div class="password-section" id="passwordSection" style="display: none;">
            <input type="password" id="passwordInput" placeholder="enter password" class="neon-input">
            <button id="joinBtn" class="neon-button small">join</button>
        </div>

        <div class="controls">
            <button id="rouletteBtn" class="neon-button">meet a stranger</button>
            <button id="chaosBtn" class="neon-button chaos">go fuck yourself</button>
        </div>

        <div class="status" id="status">connecting...</div>

        <div class="creator-credit">
            creator: @thewildfireway
        </div>
    </div>

    <script src="/webrtc.js"></script>
    <script>
        // Get room ID from URL
        const pathParts = window.location.pathname.split('/');
        const roomId = pathParts[pathParts.length - 1];
        let webrtc = null;
        
        // Set room URL
        document.getElementById('roomUrl').value = window.location.href;

        // Copy room URL
        document.getElementById('copyBtn').addEventListener('click', () => {
            const urlInput = document.getElementById('roomUrl');
            urlInput.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyBtn');
            const originalText = btn.textContent;
            btn.textContent = 'copied!';
            setTimeout(() => btn.textContent = originalText, 2000);
        });


        // Update status function
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        // Join button (for password-protected rooms)
        document.getElementById('joinBtn').addEventListener('click', async () => {
            const password = document.getElementById('passwordInput').value;
            if (!webrtc) {
                webrtc = new WebRTCManager(roomId);
                webrtc.onStatusChange = (status) => {
                    document.getElementById('status').textContent = status;
                };
            }
            await webrtc.joinRoom(password);
        });


        // Roulette button
        document.getElementById('rouletteBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${window.API_BASE || ''}/api/roulette`);
                const data = await response.json();
                if (response.ok && data.room_id !== roomId) {
                    window.location.href = `/room/${data.room_id}`;
                } else {
                    alert('No other active rooms available');
                }
            } catch (err) {
                console.error('Error finding room:', err);
            }
        });

        // Chaos button (go fuck yourself) - THE BLAST
        const chaosBtn = document.getElementById('chaosBtn');
        const chaosMessages = [
            'respect',
            'well ur a weird fella',
            'knew this button will land',
            'classic move',
            'bold choice',
            'you do you',
            'fair enough',
            'understandable',
            'have a nice day',
            'touch grass',
            'based',
            'absolute legend',
            'chaos achieved',
            'mission accomplished',
            'you win',
            'gg',
            'respect the chaos',
            'weird flex but ok',
            'noted',
            'cool story bro',
            'sigma move',
            'gigachad energy',
            'no cap',
            'fr fr',
            'on god',
            'deadass',
            'bet',
            'say less',
            'facts',
            'big mood'
        ];
        
        const memeLinks = [
            'https://youtu.be/7CawoPNkY00?si=-J5KG2H022i-B4Du',
            'https://youtu.be/dQw4w9WgXcQ',
            'https://youtu.be/j5a0jTc9S10',
            'https://youtu.be/9bZkp7q19f0',
            'https://youtu.be/ZZ5LpwO-An4',
            'https://youtu.be/kJQP7kiw5Fk',
            'https://youtu.be/fJ9rUzIMcZQ',
            'https://youtu.be/L_jWHffIx5E',
            'https://youtu.be/6n3pFFPSlW4',
            'https://youtu.be/9bZkp7q19f0',
            'https://youtu.be/ZZ5LpwO-An4',
            'https://youtu.be/kJQP7kiw5Fk',
            'https://youtu.be/fJ9rUzIMcZQ',
            'https://youtu.be/L_jWHffIx5E',
            'https://youtu.be/6n3pFFPSlW4',
            'https://youtu.be/dQw4w9WgXcQ',
            'https://youtu.be/j5a0jTc9S10',
            'https://youtu.be/9bZkp7q19f0',
            'https://youtu.be/ZZ5LpwO-An4',
            'https://youtu.be/kJQP7kiw5Fk'
        ];
        
        chaosBtn.addEventListener('click', () => {
            // Disconnect if in room
            if (webrtc) {
                webrtc.disconnect();
            }
            
            // Show random message
            const message = chaosMessages[Math.floor(Math.random() * chaosMessages.length)];
            updateStatus(message);
            
            // Pick random meme link
            const randomLink = memeLinks[Math.floor(Math.random() * memeLinks.length)];
            
            // MULTIPLE CHAOTIC EFFECTS AT ONCE
            // Effect 1: Glitch overlay
            const glitch = document.createElement('div');
            glitch.className = 'glitch-overlay';
            document.body.appendChild(glitch);
            
            // Effect 2: Random rotation
            const rotation = (Math.random() - 0.5) * 10;
            document.body.style.transform = `rotate(${rotation}deg)`;
            
            // Effect 3: Color shift
            const hue = Math.random() * 360;
            document.body.style.filter = `hue-rotate(${hue}deg) brightness(${1 + Math.random()}) saturate(${1 + Math.random()})`;
            
            // Effect 4: Shake animation
            document.body.style.animation = 'shake 0.5s';
            
            // Effect 5: Random scale
            const scale = 0.95 + Math.random() * 0.1;
            document.body.style.transform += ` scale(${scale})`;
            
            // Effect 6: Flash effect
            const flash = document.createElement('div');
            flash.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.5); z-index: 9999; pointer-events: none;';
            document.body.appendChild(flash);
            
            // Chaos button itself goes wild
            chaosBtn.style.transform = `rotate(${Math.random() * 360}deg) scale(1.2)`;
            chaosBtn.style.filter = `hue-rotate(${Math.random() * 360}deg)`;
            
            // Clean up effects after delay
            setTimeout(() => {
                glitch.remove();
                flash.remove();
                document.body.style.transform = '';
                document.body.style.filter = '';
                document.body.style.animation = '';
                chaosBtn.style.transform = '';
                chaosBtn.style.filter = '';
            }, 1500);
            
            // Redirect to random meme link
            setTimeout(() => {
                window.location.href = randomLink;
            }, 1500);
        });

        // Check if room requires password
        fetch(`${window.API_BASE || ''}/api/room/${roomId}/exists`)
            .then(res => {
                if (!res.ok) {
                    // Room doesn't exist or error
                    window.location.href = '/';
                    return;
                }
                return res.json();
            })
            .then(data => {
                if (!data) return; // Already redirected
                
                if (data.exists) {
                    if (data.password_protected) {
                        document.getElementById('passwordSection').style.display = 'flex';
                        updateStatus('password required');
                    } else {
                        webrtc = new WebRTCManager(roomId);
                        webrtc.onStatusChange = updateStatus;
                        webrtc.joinRoom();
                    }
                } else {
                    // Room doesn't exist - redirect to main
                    window.location.href = '/';
                }
            })
            .catch(err => {
                console.error('Error checking room:', err);
                // On error, redirect to main
                window.location.href = '/';
            });
    </script>
</body>
</html>

